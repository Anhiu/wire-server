# Legal hold

_Author: Tiago Loureiro, Matthias Fischmann_

---

Legal hold introduces a new type of device, named _legal hold device_, for the sake of satisfying corporate compliance rules without sacrificing end to end encryption with full transparency.


## Introduction

A _legal hold device_ is a device bound to a team user account but managed outside of the user's control - this is managed by the Legal hold service. The management/operation of said Legal hold service is of the responsibility of the team.

This Backend service makes this type of device available for clients that are visually distinguishable, for full transparency, with a clear, constant indication on the UI. There can be only one such device per user account and they can only be added to the user's device list with the user's consent and confirmed with a password prompt (if they have one - there can be exceptions such as SSO users).

A team admin may ask members of the team to be put under [legal hold](https://en.wikipedia.org/wiki/Legal_hold). Once a person is prompted, they should then verify that the presented signature matches the one generated by the legalhold service to avoid any potential [MITM attack](https://en.wikipedia.org/wiki/Man-in-the-middle_attack).

Conceptually, there are the following actors in this use case:

* A team admin - someone who requests legal hold for a specific user
* A team member - the user who will be put under legal hold
* Backend - serves as intermediary between team members/admin and the Legal hold Service
* Legal hold service - stores users' Legal hold devices on customers' premises
* Legal hold device - a user's device that is managed by customers

Once a user accepts the legal hold request, then a device is added to that user's account. This device, also known as legal hold device, is managed by the Legal hold service - only team admins can remove that device from a user's account.

Note that every user talking to someone under legal hold (including, of course, the _self_ user) is made aware by means of displaying a red dot on the user's profile.


## Consent

In addition to the popup before getting exposed to LH devices (either
by getting assigned one or by entering a conversation or connection
with one present), a user needs to *grant her consent* before she even
has the option of being exposed.

There are two stages of implementation: "implicit consent", which is a
bit of a euphemism and also sometimes is named "whitelisting teams",
and "true consent", which has not been implemented yet, but we hope
will replace "implicit consent" and become just "consent" in the
future.

Without consent (this holds both for implicit and true), users cannot
be assigned LH devices, and they cannot take part in conversations
(neither 1:1 nor group) in which LH devices are present.  See Section
"What happens with old devices or if consent is missing?".


### "Implicit" consent

For now, there is no way in the UI for the user to grant consent.
Instead, "implict consent" can be given by the site operator for any
team via an internal end-point that can only be reached from the
galley server instances:

```
GET /i/legalhold/whitelisted-teams/:tid
```
```
200 OK or 404 not found / empty body
```

```
PUT /i/legalhold/whitelisted-teams/:tid
```
```
200 OK / empty body
```

There is also code for unsetting:

```
DELETE /i/legalhold/whitelisted-teams/:tid
```
```
200 OK / empty body
```

...  but this request always returns a 5xx status.  Un-whitelisting is
hard because it potentially requires removing a lot of LH devices.
See [haddocks](https://hoogle.zinfra.io/file/wire-server/.stack-work/install/x86_64-linux/818eb97a112420cf140787d3b1ef7b3905ccba9e57737508606b41bae430e70d/8.8.4/doc/galley-0.83.0/src/Galley.API.LegalHold.html#unsetTeamLegalholdWhitelistedH).


### Future work: "real" consent

The term "consent" suggests that the user is making a choice here, an
initial opt-in.  "Implicit consent" is a short-cut that was easier to
implement; we want to implement the real thing in the future.

There will be two ways of giving consent:

1. **App settings:** there will be an extra check-box "I consent to
being asked about LH devices" with a link to further information in
the privacy settings next to "Lock with passcode".  It is checked off
by default.

2. **Team settings:** the team admin can force all users to consent to
LH.  This will trigger all apps of team members to show a popup that
gives the user the choice between checking the box in team settings,
and logging out.  If they log out and later log in again, the popup
will still be there.  There will also be an option to download a
backup file with all the conversation history up to the point when the
admin has requested consent.

The server side already implements granting explicit consent by the
user (not by team admin), but until the UI is ready, site operators
have the option of allowing LH to function on a fixed set of teams via
"implicit consent".


## Legacy clients

Similarly to users without consent, users that have legacy clients,
ie. ones that have not been upgraded since the introduction of the
Legalhold feature, will be treated differently by the backend will in
a few places in order to prevent her from getting recorded without
being asked.  See Section "What happens with old devices or if consent
is missing?".


### Identifying legacy clients

Clients can announce that they are LH-ready to the backend:

```
GET /clients/:cid
```
```
200 OK / {..., "capabilities":[]}
```

```
PUT /clients/:cid
{"capabilities":["legalhold-implicit-consent"]}
```
```
200 OK
```

```
GET /clients/:cid
```
```
200 OK / {..., "capabilities":["legalhold-implicit-consent"]}
```

New clients can also include this field when they register themselves, so they don't need to send an extra update.

Further reading:

* [haddocks for the `ClientCapability` data type](https://hoogle.zinfra.io/file/wire-server/.stack-work/install/x86_64-linux/818eb97a112420cf140787d3b1ef7b3905ccba9e57737508606b41bae430e70d/8.8.4/doc/wire-api-0.1.0/Wire-API-User-Client.html#t:ClientCapability)
* [haddocks for the `Client` data type](https://hoogle.zinfra.io/file/wire-server/.stack-work/install/x86_64-linux/818eb97a112420cf140787d3b1ef7b3905ccba9e57737508606b41bae430e70d/8.8.4/doc/wire-api-0.1.0/Wire-API-User-Client.html#t:Client)


## Legalhold device management (happy flow)

This section explains the flows for users that have only LH-capable
clients and have given consent to LH.

Request (by admin) for a user to be put under legalhold
```
POST /teams/{tid}/legalhold/{uid}
```
```
201 Created
```

Approval by the user
```
PUT /teams/{tid}/legalhold/{uid}/approve
{
  "password": <user's password> # optional if the user has no set password
}
```
```
200 OK
```

Deletion by an admin
```
DELETE /teams/{tid}/legalhold/{uid}
{
  "password": <admin's password> # optional if the admin has no set password
}
```
```
200 OK
```

Get Legal hold status for team members

```
GET /team/{tid}/members
```
```
200 OK
...
{
    "members": [{
        "user": member used id,
        ...
        "legalhold_status":  <-- new field
               "no_consent"
             | "disabled"
             | "pending"
             | "enabled",
        ...
    }
}
```

![LHFlow](https://user-images.githubusercontent.com/1105323/61390098-6bf34800-a8ba-11e9-8ba7-e0759b22a773.png)
<details>
title: Legal Hold Flow (client perspective)
=: Activation

Admin Panel -> Backend: Activate LH for Alice

Backend -> LegalHold Service: Request to create Cryptobox for Alice (does NOT include scoped token)

LegalHold Service --> Backend: Respond with Public Key etc. for Device

Backend -> Admin Panel: LH for Alice is PENDING
Backend --> Alice's Client: (Async) Request Approval for LH (includes device fingerprint)

Alice's Client -> Backend: Alice APPROVES LH

Backend -> LegalHold Service: Send scoped access_token
Backend -> Backend: Add Compliance Device to Alice
Backend -> Admin Panel: LH for Alice is ACTIVE

=: Deactivation

Admin Panel -> Backend: Deactivate LH for Alice
Backend -> Backend: Remove Compliance Device from Alice; revoke access token.
</details>


## Events

New legalhold request event:
```
{ "type": "user.legalhold-request"
, "id": UserID of the one for whom LH is being requested
, "last_prekey": Last-prekey of the legal hold device
, "client": {"id": Client ID of the legalhold device}
}
```
New legalhold enabled event:
```
{ "type": "user.legalhold-enable"
, "id": UserID for whom LH was enabled
}
```
New legalhold disabled event:
```
{ "type": "user.legalhold-disable"
, "id": UserID for whom LH was disabled
}
```

These events are sent to the user, all team members (including admins) and connections.


## What happens with old devices or if consent is missing?

A user without consent or with legacy clients (a *non-consenting user* in the following) is protected from communicating with LH client devices by the backend.  This section outlines the specifics.


### Device handshake blocking

When a client device of a non-consenting user sends a notification to
another user and a device is missing from the target device list, the
backend will not respond with a list of missing clients immediately.
Instead, it will check if the missing clients include a LH device.  If so,
and the user has no consent or the client is old, respond with 412.

Furthermore, the following end-points are blocked (non-consenting users will get 412):

* get "/users/:uid/prekeys/:cid"
* get "/users/:uid/prekeys"
* post "/users/prekeys" -d'<some mapping of uids to sets of clients>'
* post "/users/list-prekeys" -d'<some mapping of uids to sets of clients>'

The following do not change behavior; all give you is client id and device class (tablet, phone, desktop):

* get "/users/:uid/clients"
* get "/users/:uid/clients/:cid"
* post "/users/list-clients" -d'<list of user ids in some form or other>'
* post "/users/list-clients/v2" -d'<list of user ids in some form or other>'


### Legalhold device management

If the user has not given consent, things from Section "Legalhold
device management (happy flow)" turn out differently:

```
POST /teams/{tid}/legalhold/{uid}
```
```
412 missing-legalhold-consent
```

As a consequence, approval and device removal will not be possible.


### 1:1 conversation blocking

The above security measures guarantee that:

* non-consenting users will never be able to exchange messages with a
  LH device;
* if two users exchange messages and one of them has a LH device, all
  those messages will be recorded.

This and the next section introduce additional barriers that warn,
block, or disconnect users earlier for better UX.

If a user in a connection (`sent`, `pending`, or `active`) is
requested for LH (ie., enters status "pending"), and the other user is
non-consenting, the connection is blocked.  If the LH device is
removed, or consent is given, the block is removed.  The exact state
machine transitions:

* via public end-point:
  * [create connection](https://github.com/wireapp/wire-server/blob/cf87ee48602ca80429c84791b9d17e2307de285d/services/brig/src/Brig/API/Connection.hs#L91)
  * [update connection](https://github.com/wireapp/wire-server/blob/cf87ee48602ca80429c84791b9d17e2307de285d/services/brig/src/Brig/API/Connection.hs#L216-L219)
* via internal (after LH device has been added or removed):
  * [update](https://github.com/wireapp/wire-server/blob/cf87ee48602ca80429c84791b9d17e2307de285d/services/brig/src/Brig/API/Connection.hs#L345-L420)


### Conflict handling in group conversations

If a group conversation (or group in the following) is about to have
both LH devices and non-consenting users, some of them are removed
from the group to make the conflict evaporate.

*Removees* are the users who will be removed (or not allowed to join)
the group.  Which users are removees depends on who owns the group: if
at least one group admin has granted consent to LH, the removees are
constituted by all non-consenting users; otherwise, by users carrying
an LH device.  This makes sure that no group is ever left without
admins due to removing removees.


#### Case 1

A group exists with at least one non-consenting user.  LH device is
requested for another user in that group.

Result: all removees are removed from the group.  The behavior is the
same as for `DELETE /conversations/:cnv/members/:usr` (FUTUREWORK: the
event will contain the information that the removal was due to a LH
policy conflict).


#### Case 2

A group exists with at least one user with a pending or enabled LH
device.  Somebody invites users one of which has not granted consent.

Result: the invitation request `POST /conversations/{cnv}/members` is
denied entirely (the caller needs to try again with fewer users):

```
{
  "code": 412,
  "label": "missing-legalhold-consent",
  "message": "Failed to connect to a user or to invite a user \
             \to a group because somebody is under legalhold \
             \and somebody else has not granted consent."
}
```

NB: the group already has a LH device, so all admins must be
consenting, which means the removees are the ones without consent, not
the ones with LH device.


#### Case 3

A group exists with at least one non-consenting user.  Somebody
invites a user that has a pending or enabled LH device.

If the set of removees contains a user from the invitation list, the
invitation is rejected completely as in Case 2.

Otherwise, the removees are removed as in Case 1.


#### Case 4

A group is created with two conflicting users.

The request is denied on `POST /conversations` with the same error as
in Case 2.
